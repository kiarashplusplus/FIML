name: Validate LLMFeed

on:
  push:
    paths:
      - 'docs/llms.txt'
      - 'docs/llms-full.txt'
      - 'docs/.well-known/*.llmfeed.json'
      - '.github/workflows/validate-llmfeed.yml'
  pull_request:
    paths:
      - 'docs/llms.txt'
      - 'docs/llms-full.txt'
      - 'docs/.well-known/*.llmfeed.json'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-feeds:
    name: Validate LLMFeed Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install LLMFeed Validator
        run: npm install -g @25xcodes/llmfeed-validator

      - name: Validate MCP Feed
        id: validate-mcp
        run: |
          echo "## MCP Feed Validation" >> $GITHUB_STEP_SUMMARY
          if llmfeed-validate docs/.well-known/mcp.llmfeed.json --skip-signature --verbose --json > mcp-result.json 2>&1; then
            echo "✅ MCP feed is valid" >> $GITHUB_STEP_SUMMARY
            echo "mcp_valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ MCP feed validation failed" >> $GITHUB_STEP_SUMMARY
            cat mcp-result.json >> $GITHUB_STEP_SUMMARY
            echo "mcp_valid=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Validate LLM Index Feed
        id: validate-index
        run: |
          echo "## LLM Index Feed Validation" >> $GITHUB_STEP_SUMMARY
          if llmfeed-validate docs/.well-known/llm-index.llmfeed.json --skip-signature --verbose --json > index-result.json 2>&1; then
            echo "✅ LLM Index feed is valid" >> $GITHUB_STEP_SUMMARY
            echo "index_valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ LLM Index feed validation failed" >> $GITHUB_STEP_SUMMARY
            cat index-result.json >> $GITHUB_STEP_SUMMARY
            echo "index_valid=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Validate llms.txt Structure
        id: validate-llms-txt
        run: |
          echo "## llms.txt Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check required sections
          if grep -q "^# FIML" docs/llms.txt && \
             grep -q "^>" docs/llms.txt && \
             grep -q "## " docs/llms.txt; then
            echo "✅ llms.txt structure is valid" >> $GITHUB_STEP_SUMMARY
            echo "  - Has H1 heading" >> $GITHUB_STEP_SUMMARY
            echo "  - Has blockquote summary" >> $GITHUB_STEP_SUMMARY
            echo "  - Has H2 sections" >> $GITHUB_STEP_SUMMARY
            echo "llms_valid=true" >> $GITHUB_OUTPUT
          else
            echo "❌ llms.txt is missing required sections" >> $GITHUB_STEP_SUMMARY
            echo "llms_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Check Feed Consistency
        run: |
          echo "## Feed Consistency Check" >> $GITHUB_STEP_SUMMARY
          
          # Check that tool count matches
          TOOL_COUNT=$(jq '.mcp.tools | length' docs/.well-known/mcp.llmfeed.json)
          echo "- MCP tools defined: $TOOL_COUNT" >> $GITHUB_STEP_SUMMARY
          
          # Check version consistency
          VERSION=$(jq -r '.meta.version' docs/.well-known/mcp.llmfeed.json)
          echo "- FIML version in feed: $VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Overall Status" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.validate-mcp.outputs.mcp_valid }}" == "true" && \
                "${{ steps.validate-index.outputs.index_valid }}" == "true" && \
                "${{ steps.validate-llms-txt.outputs.llms_valid }}" == "true" ]]; then
            echo "✅ All LLMFeed files are valid and ready for AI agent discovery" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Some validations failed - please review the details above" >> $GITHUB_STEP_SUMMARY
          fi

  # Optional: Run the official GitHub Action for comprehensive validation
  validate-with-action:
    name: Validate with LLMFeed Action
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate MCP Feed with Action
        uses: kiarashplusplus/webmcp-tooling-suite/packages/github-action@v1
        with:
          feed: 'docs/.well-known/mcp.llmfeed.json'
          create-badge: 'false'
        continue-on-error: true

      - name: Validate Index Feed with Action
        uses: kiarashplusplus/webmcp-tooling-suite/packages/github-action@v1
        with:
          feed: 'docs/.well-known/llm-index.llmfeed.json'
          create-badge: 'false'
        continue-on-error: true
