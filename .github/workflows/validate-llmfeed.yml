name: Validate LLMFeed

on:
  push:
    branches: [main]
    paths:
      - 'docs/llms.txt'
      - 'docs/llms-full.txt'
      - 'docs/.well-known/*.llmfeed.json'
      - '.github/workflows/validate-llmfeed.yml'
  pull_request:
    paths:
      - 'docs/llms.txt'
      - 'docs/llms-full.txt'
      - 'docs/.well-known/*.llmfeed.json'
  workflow_dispatch:

jobs:
  validate:
    name: Validate LLMFeed Files
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate MCP Feed
        id: validate-mcp
        uses: kiarashplusplus/webmcp-tooling-suite/packages/github-action@v1
        with:
          feed: 'docs/.well-known/mcp.llmfeed.json'
          skip-signature: 'true'
          create-badge: 'true'
          badge-path: '.github/badges/llmfeed-mcp.svg'

      - name: Validate LLM Index Feed
        uses: kiarashplusplus/webmcp-tooling-suite/packages/github-action@v1
        with:
          feed: 'docs/.well-known/llm-index.llmfeed.json'
          skip-signature: 'true'

      - name: Validate llms.txt Structure
        run: |
          echo "## llms.txt Validation" >> $GITHUB_STEP_SUMMARY
          
          # Check required sections per llms.txt spec
          if grep -q "^# " docs/llms.txt && \
             grep -q "^>" docs/llms.txt && \
             grep -q "^## " docs/llms.txt; then
            echo "âœ… llms.txt structure is valid" >> $GITHUB_STEP_SUMMARY
            echo "  - Has H1 heading" >> $GITHUB_STEP_SUMMARY
            echo "  - Has blockquote summary" >> $GITHUB_STEP_SUMMARY
            echo "  - Has H2 sections" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ llms.txt is missing required sections" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Commit badge files
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/badges/
          git diff --staged --quiet || git commit -m "chore: update LLMFeed validation badge [skip ci]"
          git push

      - name: Feed Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## Feed Details" >> $GITHUB_STEP_SUMMARY
          
          TOOL_COUNT=$(jq '.mcp.tools | length' docs/.well-known/mcp.llmfeed.json)
          VERSION=$(jq -r '.meta.version' docs/.well-known/mcp.llmfeed.json)
          SECTION_COUNT=$(jq '.sections | length' docs/.well-known/llm-index.llmfeed.json)
          
          echo "- **MCP tools**: $TOOL_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **FIML version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Doc sections**: $SECTION_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Score**: ${{ steps.validate-mcp.outputs.security-score }}/100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ [View MCP Feed](https://kiarashplusplus.github.io/FIML/.well-known/mcp.llmfeed.json)" >> $GITHUB_STEP_SUMMARY
          
          # Show badge URL for README
          if [ -n "${{ steps.validate-mcp.outputs.badge-url }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“› Badge" >> $GITHUB_STEP_SUMMARY
            echo '```markdown' >> $GITHUB_STEP_SUMMARY
            echo '[![LLMFeed](${{ steps.validate-mcp.outputs.badge-url }})](https://kiarashplusplus.github.io/FIML/.well-known/mcp.llmfeed.json)' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
